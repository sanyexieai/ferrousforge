# GitLab CI 配置

stages:
  - check
  - test
  - build
  - release

variables:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

# 缓存配置
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - target/
    - .cargo/

# 代码检查和格式化
check:
  stage: check
  image: rust:latest
  before_script:
    - rustup component add rustfmt clippy
  script:
    - cargo fmt --all -- --check
    - cargo check --all-features
    - cargo clippy --all-features -- -D warnings
  only:
    - merge_requests
    - main
    - develop

# 运行测试
test:
  stage: test
  image: rust:latest
  script:
    - cargo test --all-features --verbose
  coverage: '/^test result:.*\s+(\d+\.\d+)%.*$/'
  only:
    - merge_requests
    - main
    - develop

# 构建 Release
build:
  stage: build
  image: rust:latest
  script:
    - cargo build --release --verbose
  artifacts:
    paths:
      - target/release/ferrousforge
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

# 多平台构建
build:linux:
  stage: build
  image: rust:latest
  script:
    - cargo build --release --verbose
  artifacts:
    paths:
      - target/release/ferrousforge
    expire_in: 1 week
  only:
    - tags

build:windows:
  stage: build
  image: rustlang/rust:nightly
  before_script:
    - rustup target add x86_64-pc-windows-msvc
  script:
    - cargo build --release --target x86_64-pc-windows-msvc --verbose
  artifacts:
    paths:
      - target/x86_64-pc-windows-msvc/release/ferrousforge.exe
    expire_in: 1 week
  only:
    - tags

build:macos:
  stage: build
  image: rust:latest
  before_script:
    - rustup target add x86_64-apple-darwin
  script:
    - cargo build --release --target x86_64-apple-darwin --verbose
  artifacts:
    paths:
      - target/x86_64-apple-darwin/release/ferrousforge
    expire_in: 1 week
  only:
    - tags

# 发布（仅当打 tag 时）
release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - echo "Release job - 可以在这里添加发布逻辑"
  only:
    - tags
  when: manual

